# Project Rules（AI IDE 工程规则）

> 本文档用于约束 AI IDE 在本项目中的代码生成、修改与设计行为，目标是：**可维护、可理解、可扩展、可验证**。任何 AI 生成的代码都必须遵循以下规则。

---

## 1. 总体原则（General Principles）

1. **正确性优先于炫技**  
   - 禁止为了“看起来高级”而引入不必要的抽象、设计模式或第三方库。
   - 任何实现必须以业务正确性和可验证性为第一目标。

2. **可读性 > 简洁性 > 性能**（在无明确性能瓶颈前）  
   - 优先写“人能一眼看懂的代码”，而不是“最短的代码”。

3. **显式优于隐式（Explicit over Implicit）**  
   - 禁止依赖魔法行为、隐式约定、隐藏副作用。
   - 所有关键逻辑必须在代码中清晰呈现。

4. **最小改动原则**  
   - 修改功能时，只允许改动与该功能直接相关的代码。
   - 严禁“顺手重构”“顺手优化”。

---

## 2. 项目结构约定（Project Structure）

### 2.1 目录结构

- 每一层目录必须有**单一职责**
- 不允许出现以下模糊目录名：
  - `utils2`、`temp`、`test123`、`misc`

示例：

```
/src
  /api        # 对外接口（HTTP / RPC）
  /service    # 业务逻辑（核心）
  /domain     # 领域模型 / 数据结构
  /infra      # 数据库、缓存、第三方服务
  /config     # 配置
```

### 2.2 文件职责

- 一个文件 = 一个清晰职责
- 超过 **300 行** 的文件，必须拆分
- 一个函数不应超过 **50 行**（特殊情况需注释说明）

---

## 3. 编码规范（Coding Standards）

### 3.1 命名规则

- 命名必须 **表达业务含义**，禁止抽象名：
  - ❌ `data`, `info`, `handle`, `process`
  - ✅ `weeklySalesSummary`, `calculateChurnRate`

- 布尔变量必须是“可读判断句”：
  - ✅ `isActive`, `hasPermission`, `shouldRetry`

---

### 3.2 函数设计

- 单一职责原则（SRP）
- 禁止在一个函数中同时做：
  - 数据校验 + 数据查询 + 业务计算 + IO 输出

推荐结构：

```
validateInput()
fetchData()
calculateResult()
formatOutput()
```

---

### 3.3 注释规范

- **解释“为什么”，而不是“做了什么”**
- 以下情况必须写注释：
  - 复杂业务规则
  - 非直觉的判断条件
  - 历史遗留 / 临时方案（需注明 TODO）

---

## 4. 业务逻辑规则（Business Logic Rules）

1. **业务规则禁止写在 Controller / UI 层**  
   - Controller 只做参数接收与结果返回

2. **禁止在业务代码中硬编码常量**  
   - 所有阈值、枚举、配置必须集中管理

3. **时间、金额、比例必须统一口径**  
   - 明确：
     - 时区
     - 精度（小数位）
     - 四舍五入规则

---

## 5. 错误处理规则（Error Handling）

1. 禁止 `try-catch` 吞异常
2. 错误必须包含：
   - 错误类型
   - 错误原因
   - 可读的错误信息

3. 业务错误 ≠ 系统错误，必须区分

---

## 6. 日志与调试（Logging）

- 关键路径必须有日志：
  - 输入
  - 关键决策点
  - 输出结果

- 禁止：
  - 打印敏感信息
  - 在循环中大量打日志

---

## 7. AI IDE 行为约束（非常重要）

AI 在执行任何任务前，**必须先输出分析结论**，包括：

1. 要实现什么功能
2. 会改动哪些文件
3. 是否存在潜在风险
4. 是否需要人工确认

### 严格禁止以下行为：

- 未经允许引入新框架 / 新语言
- 未经允许修改项目结构
- 为“未来可能用到”而写代码
- 擅自重构已有稳定代码

---

## 8. 交付标准（Definition of Done）

一个功能被认为“完成”，必须满足：

- 功能逻辑完整
- 代码可读、可解释
- 无明显冗余
- 不影响已有功能
- AI 能清楚说明每一处改动的原因

---

## 9. 环境变量与配置文件约束（Environment Rules）

1. **严禁改动 `.env` 文件**  
   - AI 在任何情况下 **不得新增、删除或修改** `.env` 文件中的内容。
   - 包括但不限于：
     - 新增环境变量
     - 修改变量值
     - 调整变量命名

2. **禁止假设 `.env` 中存在未明确说明的变量**  
   - 若业务逻辑依赖新的环境变量，必须：
     1. 明确说明需要新增的变量名及用途；
     2. 停止实现；
     3. 请求人工确认。

3. **配置变更的替代方案**  
   - 所有非敏感、可代码内表达的配置，应优先：
     - 使用配置文件（如 `config/*`）
     - 使用常量定义（如 `constants.ts`）
   - `.env` 仅用于运行环境注入，不作为业务逻辑演进的手段。

---

## 10. 文档规范：README.md 与 CHANGELOG.md

### 10.1 README.md 撰写要求

README.md 是**项目的唯一权威说明入口**，必须保持准确、简洁、可执行。

#### 必须包含的内容

1. **项目简介（What）**  
   - 项目解决什么问题
   - 适用的使用场景
   - 不解决什么问题（明确边界）

2. **核心功能列表（Capabilities）**  
   - 使用业务语言描述功能
   - 禁止直接贴实现细节或代码

3. **运行与使用方式（How）**  
   - 如何启动项目
   - 关键依赖说明（但不展开安装细节）

4. **配置说明（Configuration）**  
   - 明确说明：`.env` 为只读，不允许由 AI 修改
   - 列出项目依赖的配置项来源（如 config 文件）

#### 明确禁止的内容

- 冗长背景故事
- AI 自动生成但未人工校验的描述
- 与当前代码实现不一致的说明

> README.md 的目标读者是：**未来的你，而不是现在的 AI。**

---

### 10.2 CHANGELOG.md 记录要求

CHANGELOG.md 用于**记录真实发生过的变更历史**，是审计与回溯的重要依据。

#### 基本规则

1. **只记录已经发生的变更**  
   - 禁止记录“计划中”“可能会做”的内容

2. **按时间倒序记录**（最新在最上方）

3. 每一次变更记录必须包含：
   - 变更日期
   - 变更类型（新增 / 修改 / 修复 / 移除）
   - 简要说明（业务层面）

示例格式：

```
## 2026-01-13
### Changed
- 调整会员流失率计算口径，统一按自然月统计

### Fixed
- 修复跨年周统计导致 2025 年数据为空的问题
```

#### AI 行为约束

- AI **不得伪造或补写历史变更**
- AI 只能在以下情况下修改 CHANGELOG.md：
  1. 本次任务明确包含“需要记录变更日志”；
  2. 或你明确要求更新 CHANGELOG.md。

---

## 11. 当规则冲突时

优先级如下：

1. 本文档规则
2. 业务需求说明
3. 通用最佳实践

---

> 结论：**AI 是执行者，不是决策者。任何超出规则的行为，必须停止并请求人工确认。**

